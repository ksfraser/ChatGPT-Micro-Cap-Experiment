<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Financial Analysis Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            color: #7f8c8d;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        .tabs {
            display: flex;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 30px;
        }
        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            color: #6c757d;
        }
        .tab.active {
            background-color: #007bff;
            color: white;
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        }
        .tab:hover:not(.active) {
            background-color: #e9ecef;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #343a40;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .results h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
            margin-top: 20px;
        }
        .metric-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .metric-card h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.1em;
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        pre {
            background-color: #f1f3f4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Advanced Financial Analysis</h1>
            <p>Professional-grade technical indicators, risk analysis, and portfolio optimization</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('indicators')">Technical Indicators</button>
            <button class="tab" onclick="showTab('shannon')">Shannon Analysis</button>
            <button class="tab" onclick="showTab('risk')">Risk Management</button>
            <button class="tab" onclick="showTab('optimization')">Portfolio Optimization</button>
            <button class="tab" onclick="showTab('backtest')">Backtesting</button>
            <button class="tab" onclick="showTab('correlation')">Correlation Analysis</button>
        </div>

        <!-- Technical Indicators Tab -->
        <div id="indicators" class="tab-content active">
            <h2>üìä Advanced Technical Indicators</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="indicators-symbol">Symbol:</label>
                    <input type="text" id="indicators-symbol" placeholder="AAPL" value="AAPL">
                </div>
                <div class="form-group">
                    <label for="indicators-period">Period:</label>
                    <input type="number" id="indicators-period" value="14" min="1" max="100">
                </div>
                <div class="form-group">
                    <label for="indicators-limit">Data Points:</label>
                    <input type="number" id="indicators-limit" value="100" min="50" max="500">
                </div>
            </div>

            <label>Select Indicators:</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="ind-adx" checked>
                    <label for="ind-adx">ADX (Average Directional Index)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="ind-bollinger" checked>
                    <label for="ind-bollinger">Bollinger Bands</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="ind-stochastic" checked>
                    <label for="ind-stochastic">Stochastic Oscillator</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="ind-williams">
                    <label for="ind-williams">Williams %R</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="ind-cci">
                    <label for="ind-cci">CCI (Commodity Channel Index)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="ind-roc">
                    <label for="ind-roc">ROC (Rate of Change)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="ind-obv">
                    <label for="ind-obv">OBV (On Balance Volume)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="ind-sar">
                    <label for="ind-sar">Parabolic SAR</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="ind-aroon">
                    <label for="ind-aroon">Aroon Oscillator</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="ind-atr">
                    <label for="ind-atr">ATR (Average True Range)</label>
                </div>
            </div>

            <button class="btn" onclick="getAdvancedIndicators()">Calculate Indicators</button>
            <button class="btn btn-secondary" onclick="selectAllIndicators()">Select All</button>
        </div>

        <!-- Shannon Analysis Tab -->
        <div id="shannon" class="tab-content">
            <h2>üî¨ Shannon Probability Analysis</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="shannon-symbol">Symbol:</label>
                    <input type="text" id="shannon-symbol" placeholder="AAPL" value="AAPL">
                </div>
                <div class="form-group">
                    <label for="shannon-window">Analysis Window:</label>
                    <input type="number" id="shannon-window" value="20" min="10" max="100">
                </div>
                <div class="form-group">
                    <label for="shannon-limit">Data Points:</label>
                    <input type="number" id="shannon-limit" value="100" min="50" max="500">
                </div>
            </div>

            <button class="btn" onclick="getShannonAnalysis()">Analyze Shannon Probability</button>
            <p style="color: #6c757d; font-style: italic;">
                Shannon analysis provides probability-based equity selection using information theory, 
                persistence analysis, and mean reversion detection.
            </p>
        </div>

        <!-- Risk Management Tab -->
        <div id="risk" class="tab-content">
            <h2>‚ö†Ô∏è Portfolio Risk Analysis</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="risk-portfolio">Portfolio ID:</label>
                    <input type="number" id="risk-portfolio" placeholder="1" value="1">
                </div>
                <div class="form-group">
                    <label for="risk-period">Analysis Period (days):</label>
                    <input type="number" id="risk-period" value="252" min="30" max="1000">
                </div>
                <div class="form-group">
                    <label for="risk-free-rate">Risk-Free Rate:</label>
                    <input type="number" id="risk-free-rate" value="0.02" step="0.001" min="0" max="0.1">
                </div>
            </div>

            <button class="btn" onclick="getRiskMetrics()">Calculate Risk Metrics</button>
            <p style="color: #6c757d; font-style: italic;">
                Comprehensive risk analysis including VaR, Sharpe ratio, maximum drawdown, and concentration risk.
            </p>
        </div>

        <!-- Portfolio Optimization Tab -->
        <div id="optimization" class="tab-content">
            <h2>üéØ Portfolio Optimization</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="opt-symbols">Symbols (comma-separated):</label>
                    <input type="text" id="opt-symbols" placeholder="AAPL,MSFT,GOOGL,AMZN" value="AAPL,MSFT,GOOGL">
                </div>
                <div class="form-group">
                    <label for="opt-method">Optimization Method:</label>
                    <select id="opt-method">
                        <option value="shannon">Shannon Information Theory</option>
                        <option value="kelly">Kelly Criterion</option>
                        <option value="entropy_weighted">Entropy Weighted</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="opt-risk-tolerance">Risk Tolerance (0-1):</label>
                    <input type="number" id="opt-risk-tolerance" value="0.5" step="0.1" min="0" max="1">
                </div>
            </div>

            <button class="btn" onclick="optimizePortfolio()">Optimize Portfolio</button>
            <p style="color: #6c757d; font-style: italic;">
                Advanced portfolio optimization using Shannon information theory and other sophisticated methods.
            </p>
        </div>

        <!-- Backtesting Tab -->
        <div id="backtest" class="tab-content">
            <h2>üìà Strategy Backtesting</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="bt-symbol">Symbol:</label>
                    <input type="text" id="bt-symbol" placeholder="AAPL" value="AAPL">
                </div>
                <div class="form-group">
                    <label for="bt-strategy">Strategy:</label>
                    <select id="bt-strategy">
                        <option value="simple_ma">Simple Moving Average</option>
                        <option value="bollinger_bands">Bollinger Bands</option>
                        <option value="mean_reversion">Mean Reversion</option>
                        <option value="momentum">Momentum</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bt-capital">Initial Capital:</label>
                    <input type="number" id="bt-capital" value="100000" min="1000" max="10000000">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="bt-start-date">Start Date:</label>
                    <input type="date" id="bt-start-date">
                </div>
                <div class="form-group">
                    <label for="bt-end-date">End Date:</label>
                    <input type="date" id="bt-end-date">
                </div>
            </div>

            <button class="btn" onclick="runBacktest()">Run Backtest</button>
            <p style="color: #6c757d; font-style: italic;">
                Comprehensive backtesting with slippage, commissions, and advanced performance metrics.
            </p>
        </div>

        <!-- Correlation Analysis Tab -->
        <div id="correlation" class="tab-content">
            <h2>üîó Correlation Analysis</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="corr-symbols">Symbols (comma-separated):</label>
                    <input type="text" id="corr-symbols" placeholder="AAPL,MSFT,GOOGL,AMZN,TSLA" value="AAPL,MSFT,GOOGL,AMZN">
                </div>
                <div class="form-group">
                    <label for="corr-period">Analysis Period (days):</label>
                    <input type="number" id="corr-period" value="252" min="30" max="1000">
                </div>
            </div>

            <button class="btn" onclick="getCorrelationMatrix()">Calculate Correlation Matrix</button>
            <p style="color: #6c757d; font-style: italic;">
                Analyze correlations between assets to understand diversification benefits and risk concentration.
            </p>
        </div>

        <div class="loading" id="loading">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p>Processing your request...</p>
        </div>

        <div id="results" class="results" style="display: none;">
            <h3>Analysis Results</h3>
            <div id="results-content"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api/advanced';

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content and mark tab as active
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            // Animate progress bar
            let progress = 0;
            const progressBar = document.getElementById('progress-fill');
            const interval = setInterval(() => {
                progress += 5;
                progressBar.style.width = progress + '%';
                if (progress >= 90) {
                    clearInterval(interval);
                }
            }, 100);
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('progress-fill').style.width = '100%';
            setTimeout(() => {
                document.getElementById('progress-fill').style.width = '0%';
            }, 500);
        }

        function showResults(title, content) {
            hideLoading();
            document.getElementById('results').style.display = 'block';
            document.querySelector('#results h3').textContent = title;
            document.getElementById('results-content').innerHTML = content;
        }

        function showError(message) {
            hideLoading();
            document.getElementById('results').style.display = 'block';
            document.querySelector('#results h3').textContent = 'Error';
            document.getElementById('results-content').innerHTML = 
                `<div class="error">${message}</div>`;
        }

        function selectAllIndicators() {
            document.querySelectorAll('#indicators input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        }

        async function getAdvancedIndicators() {
            const symbol = document.getElementById('indicators-symbol').value.toUpperCase();
            const period = document.getElementById('indicators-period').value;
            const limit = document.getElementById('indicators-limit').value;
            
            if (!symbol) {
                showError('Please enter a symbol');
                return;
            }

            showLoading();

            // Build query parameters based on selected indicators
            const params = new URLSearchParams({
                period: period,
                limit: limit
            });

            // Add selected indicators
            document.querySelectorAll('#indicators input[type="checkbox"]:checked').forEach(checkbox => {
                const indicatorName = checkbox.id.replace('ind-', '');
                params.append(indicatorName, 'true');
            });

            try {
                const response = await fetch(`${API_BASE_URL}/indicators/${symbol}?${params}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch indicators');
                }

                let content = `
                    <div class="metric-card">
                        <h4>üìä Symbol: ${data.symbol}</h4>
                        <p><strong>Period:</strong> ${data.period} | <strong>Data Points:</strong> ${data.data_points}</p>
                    </div>
                `;

                Object.entries(data.indicators).forEach(([indicator, values]) => {
                    content += `
                        <div class="metric-card">
                            <h4>${indicator.replace(/_/g, ' ').toUpperCase()}</h4>
                            <p><strong>Latest Values:</strong></p>
                            <pre>${JSON.stringify(values.slice(-5), null, 2)}</pre>
                        </div>
                    `;
                });

                showResults('Technical Indicators Analysis', content);

            } catch (error) {
                showError(error.message);
            }
        }

        async function getShannonAnalysis() {
            const symbol = document.getElementById('shannon-symbol').value.toUpperCase();
            const window = document.getElementById('shannon-window').value;
            const limit = document.getElementById('shannon-limit').value;
            
            if (!symbol) {
                showError('Please enter a symbol');
                return;
            }

            showLoading();

            try {
                const response = await fetch(`${API_BASE_URL}/shannon/${symbol}?window=${window}&limit=${limit}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch Shannon analysis');
                }

                const latest = data.shannon_probability[data.shannon_probability.length - 1];

                let content = `
                    <div class="metric-grid">
                        <div class="metric-card">
                            <h4>üéØ Shannon Probability</h4>
                            <p><strong>Probability:</strong> ${(latest.probability * 100).toFixed(2)}%</p>
                            <p><strong>Effective Probability:</strong> ${(latest.effective_probability * 100).toFixed(2)}%</p>
                            <p><strong>Accuracy:</strong> ${latest.accuracy.toFixed(2)}%</p>
                        </div>
                        <div class="metric-card">
                            <h4>üìà Market Statistics</h4>
                            <p><strong>Mean Return:</strong> ${(latest.mean_return * 100).toFixed(4)}%</p>
                            <p><strong>Volatility:</strong> ${(latest.volatility * 100).toFixed(4)}%</p>
                            <p><strong>Entropy:</strong> ${latest.entropy?.toFixed(4) || 'N/A'}</p>
                        </div>
                        <div class="metric-card">
                            <h4>üî¨ Persistence Analysis</h4>
                            <p><strong>Hurst Exponent:</strong> ${data.persistence_analysis.hurst_exponent?.toFixed(4) || 'N/A'}</p>
                            <p><strong>Interpretation:</strong> ${data.persistence_analysis.interpretation || 'N/A'}</p>
                        </div>
                        <div class="metric-card">
                            <h4>‚Ü©Ô∏è Mean Reversion</h4>
                            <p><strong>Score:</strong> ${data.mean_reversion_analysis.mean_reversion_score?.toFixed(4) || 'N/A'}</p>
                            <p><strong>Is Mean Reverting:</strong> ${data.mean_reversion_analysis.is_mean_reverting ? 'Yes' : 'No'}</p>
                        </div>
                    </div>
                `;

                showResults('Shannon Probability Analysis', content);

            } catch (error) {
                showError(error.message);
            }
        }

        async function getRiskMetrics() {
            const portfolioId = document.getElementById('risk-portfolio').value;
            const period = document.getElementById('risk-period').value;
            const riskFreeRate = document.getElementById('risk-free-rate').value;
            
            if (!portfolioId) {
                showError('Please enter a portfolio ID');
                return;
            }

            showLoading();

            try {
                const response = await fetch(`${API_BASE_URL}/portfolio/${portfolioId}/risk?period=${period}&risk_free_rate=${riskFreeRate}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch risk metrics');
                }

                let content = `
                    <div class="metric-grid">
                        <div class="metric-card">
                            <h4>üìâ Value at Risk (VaR)</h4>
                            <p><strong>95% VaR:</strong> ${(data.var_analysis.var_95.parametric_var * 100).toFixed(2)}%</p>
                            <p><strong>99% VaR:</strong> ${(data.var_analysis.var_99.parametric_var * 100).toFixed(2)}%</p>
                        </div>
                        <div class="metric-card">
                            <h4>üìä Performance Metrics</h4>
                            <p><strong>Sharpe Ratio:</strong> ${data.performance_metrics.sharpe_ratio.toFixed(4)}</p>
                            <p><strong>Max Drawdown:</strong> ${(data.performance_metrics.max_drawdown.max_drawdown_percent || 0).toFixed(2)}%</p>
                            <p><strong>Volatility:</strong> ${(data.performance_metrics.volatility * 100).toFixed(2)}%</p>
                        </div>
                        <div class="metric-card">
                            <h4>üéØ Concentration Risk</h4>
                            <p><strong>HHI:</strong> ${data.concentration_risk.hhi.toFixed(4)}</p>
                            <p><strong>Effective Assets:</strong> ${data.concentration_risk.effective_assets.toFixed(2)}</p>
                            <p><strong>Diversification Score:</strong> ${data.concentration_risk.diversification_score.toFixed(4)}</p>
                        </div>
                    </div>
                `;

                showResults('Portfolio Risk Analysis', content);

            } catch (error) {
                showError(error.message);
            }
        }

        async function optimizePortfolio() {
            const symbols = document.getElementById('opt-symbols').value.split(',').map(s => s.trim().toUpperCase());
            const method = document.getElementById('opt-method').value;
            const riskTolerance = document.getElementById('opt-risk-tolerance').value;
            
            if (symbols.length < 2) {
                showError('Please enter at least 2 symbols');
                return;
            }

            showLoading();

            try {
                const response = await fetch(`${API_BASE_URL}/optimize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbols: symbols,
                        method: method,
                        risk_tolerance: parseFloat(riskTolerance)
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to optimize portfolio');
                }

                let weightsContent = '';
                Object.entries(data.optimal_weights).forEach(([symbol, weight]) => {
                    weightsContent += `<p><strong>${symbol}:</strong> ${(weight * 100).toFixed(2)}%</p>`;
                });

                let content = `
                    <div class="metric-grid">
                        <div class="metric-card">
                            <h4>üéØ Optimal Weights</h4>
                            ${weightsContent}
                        </div>
                        <div class="metric-card">
                            <h4>üìà Expected Performance</h4>
                            <p><strong>Expected Return:</strong> ${(data.expected_return * 100).toFixed(2)}%</p>
                            <p><strong>Expected Risk:</strong> ${(data.expected_risk * 100).toFixed(2)}%</p>
                            <p><strong>Sharpe Ratio:</strong> ${data.sharpe_ratio.toFixed(4)}</p>
                        </div>
                        <div class="metric-card">
                            <h4>‚öôÔ∏è Optimization Details</h4>
                            <p><strong>Method:</strong> ${method.replace('_', ' ').toUpperCase()}</p>
                            <p><strong>Assets:</strong> ${symbols.length}</p>
                            <p><strong>Risk Tolerance:</strong> ${riskTolerance}</p>
                        </div>
                    </div>
                `;

                showResults('Portfolio Optimization Results', content);

            } catch (error) {
                showError(error.message);
            }
        }

        async function runBacktest() {
            const symbol = document.getElementById('bt-symbol').value.toUpperCase();
            const strategy = document.getElementById('bt-strategy').value;
            const initialCapital = document.getElementById('bt-capital').value;
            const startDate = document.getElementById('bt-start-date').value;
            const endDate = document.getElementById('bt-end-date').value;
            
            if (!symbol) {
                showError('Please enter a symbol');
                return;
            }

            showLoading();

            try {
                const body = {
                    symbol: symbol,
                    strategy: strategy,
                    initial_capital: parseFloat(initialCapital)
                };

                if (startDate) body.start_date = startDate;
                if (endDate) body.end_date = endDate;

                const response = await fetch(`${API_BASE_URL}/backtest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to run backtest');
                }

                let content = `
                    <div class="metric-grid">
                        <div class="metric-card">
                            <h4>üí∞ Performance Summary</h4>
                            <p><strong>Initial Capital:</strong> $${data.results.initial_capital?.toLocaleString() || 'N/A'}</p>
                            <p><strong>Final Capital:</strong> $${data.results.final_capital?.toLocaleString() || 'N/A'}</p>
                            <p><strong>Total Return:</strong> ${((data.results.total_return || 0) * 100).toFixed(2)}%</p>
                            <p><strong>Annualized Return:</strong> ${((data.results.annualized_return || 0) * 100).toFixed(2)}%</p>
                        </div>
                        <div class="metric-card">
                            <h4>üìä Risk Metrics</h4>
                            <p><strong>Max Drawdown:</strong> ${((data.results.max_drawdown?.max_drawdown || 0) * 100).toFixed(2)}%</p>
                            <p><strong>Sharpe Ratio:</strong> ${(data.results.sharpe_ratio || 0).toFixed(4)}</p>
                            <p><strong>Profit Factor:</strong> ${(data.results.profit_factor || 0).toFixed(4)}</p>
                        </div>
                        <div class="metric-card">
                            <h4>üìà Trading Statistics</h4>
                            <p><strong>Total Trades:</strong> ${data.results.total_trades || 0}</p>
                            <p><strong>Win Rate:</strong> ${((data.results.win_rate || 0) * 100).toFixed(2)}%</p>
                            <p><strong>Avg Win:</strong> $${(data.results.avg_win || 0).toFixed(2)}</p>
                            <p><strong>Avg Loss:</strong> $${(data.results.avg_loss || 0).toFixed(2)}</p>
                        </div>
                    </div>
                `;

                showResults('Backtest Results', content);

            } catch (error) {
                showError(error.message);
            }
        }

        async function getCorrelationMatrix() {
            const symbols = document.getElementById('corr-symbols').value.split(',').map(s => s.trim().toUpperCase());
            const period = document.getElementById('corr-period').value;
            
            if (symbols.length < 2) {
                showError('Please enter at least 2 symbols');
                return;
            }

            showLoading();

            try {
                const response = await fetch(`${API_BASE_URL}/correlation?${new URLSearchParams({
                    symbols: symbols.join(','),
                    period: period
                })}`);

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to calculate correlation matrix');
                }

                let matrixContent = '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
                matrixContent += '<tr><th style="border: 1px solid #ddd; padding: 8px; background: #f8f9fa;"></th>';
                
                // Header row
                data.symbols.forEach(symbol => {
                    matrixContent += `<th style="border: 1px solid #ddd; padding: 8px; background: #f8f9fa; text-align: center;">${symbol}</th>`;
                });
                matrixContent += '</tr>';

                // Data rows
                data.symbols.forEach(symbol1 => {
                    matrixContent += `<tr><th style="border: 1px solid #ddd; padding: 8px; background: #f8f9fa;">${symbol1}</th>`;
                    data.symbols.forEach(symbol2 => {
                        const correlation = data.correlation_matrix[symbol1][symbol2];
                        const cellColor = correlation > 0.7 ? '#ffebee' : correlation < -0.7 ? '#e8f5e8' : '#fff';
                        matrixContent += `<td style="border: 1px solid #ddd; padding: 8px; text-align: center; background-color: ${cellColor};">${correlation.toFixed(3)}</td>`;
                    });
                    matrixContent += '</tr>';
                });
                matrixContent += '</table>';

                let content = `
                    <div class="metric-card">
                        <h4>üîó Correlation Matrix</h4>
                        <p><strong>Analysis Period:</strong> ${period} days</p>
                        <p><strong>Assets:</strong> ${data.symbols.join(', ')}</p>
                        <p style="font-size: 12px; color: #6c757d;">
                            Red cells indicate high positive correlation (>0.7), green cells indicate high negative correlation (<-0.7)
                        </p>
                        ${matrixContent}
                    </div>
                `;

                showResults('Correlation Analysis', content);

            } catch (error) {
                showError(error.message);
            }
        }

        // Set default dates for backtesting
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            
            document.getElementById('bt-end-date').value = today.toISOString().split('T')[0];
            document.getElementById('bt-start-date').value = oneYearAgo.toISOString().split('T')[0];
        });
    </script>
</body>
</html>
